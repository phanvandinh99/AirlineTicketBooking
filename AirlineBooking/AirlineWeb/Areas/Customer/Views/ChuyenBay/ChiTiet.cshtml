@model AirlineWeb.Models.ChuyenBay
@{
    ViewBag.Title = "Chi Tiết";
    Layout = "~/Areas/Customer/Views/Shared/_LayoutDetailCustomer.cshtml";
}

@{
    var lichList = Model.LichBay != null ? Model.LichBay.ToList() : new List<AirlineWeb.Models.LichBay>();
    var lichSomNhat = lichList.OrderBy(l => l.NgayGioKhoiHanh).FirstOrDefault();

    // Lấy danh sách hạng vé và sắp xếp theo TyLeGia giảm dần
    var hangVeList = new List<AirlineWeb.Models.HangVe>();
    if (lichSomNhat != null && lichSomNhat.VeChuyenBay != null)
    {
        hangVeList = lichSomNhat.VeChuyenBay
            .Select(v => v.HangVe)
            .Where(hv => hv != null)
            .Distinct()
            .OrderByDescending(hv => hv.TyLeGia)
            .ToList();
    }

    // Định nghĩa số cột cho từng hạng vé (theo MaHangVe trong Bảng Hạng Vé)
    var hangVeConfig = new Dictionary<string, int>
{
        { "HV04", 1 },      // Hạng nhất: 1 cột (A)
        { "HV03", 2 },      // Thương gia: 2 cột (A, B)
        { "HV02", 4 },      // Phổ thông cao cấp: 4 cột (A, B, C, D)
        { "HV01", 6 }       // Phổ thông: 6 cột (A, B, C, D, E, F)
    };
}

<!-- #region Nội dung chính -->

<div class="col-xl-8">
    <!-- Slider -->
    <div>
        <div class="service-wrap slider-wrap-five mb-4">
            <div class="d-flex align-items-center justify-content-between flex-wrap mb-2">
                <div class="mb-2">
                    <h4 class="mb-1 d-flex align-items-center flex-wrap">
                        @Model.HangHangKhong.TenHang
                    </h4>
                    <div class="d-flex align-items-center flex-wrap">
                        <p class="fs-14 mb-2 me-3 pe-3 border-end d-flex align-items-center">
                            <img src="~/Assets/Customer/img/icons/airindia.svg" class="me-2" alt="Img"> @Model.HangHangKhong.TenHang
                            <span class="bg-primary divide-point mx-2"></span> @Model.HangHangKhong.MaHangHangKhong
                        </p>
                        <p class="fs-14 mb-2 me-3 pe-3 border-end">
                            <i class="isax isax-location5 me-2"></i>@Model.TuyenBay.SanBay.ThanhPho, @Model.TuyenBay.SanBay.QuocGia
                            <a href="#location" class="link-primary text-decoration-underline fw-medium ms-2">@Model.TuyenBay.SanBay.TenSanBay</a>
                        </p>
                    </div>
                </div>
                <div class="d-flex align-items-center mb-3">
                    <a href="javascript:void(0);" class="btn btn-outline-light btn-icon btn-sm d-flex align-items-center justify-content-center me-2"><i class="isax isax-share"></i></a>
                    <a href="javascript:void(0);" class="btn btn-outline-light btn-sm d-inline-flex align-items-center">
                        <i class="isax isax-heart5 text-danger me-1"></i>Yêu thích
                    </a>
                </div>
            </div>
            <div class="service-wrap mb-4">
                <div class="slider-wrap">
                    <div class="owl-carousel service-carousel nav-center mb-4" id="large-img">
                        <div class="service-img">
                            <img src="~/Assets/Customer/img/flight/flight-large-01.jpg" class="img-fluid" alt="Slider Img">
                        </div>
                        <div class="service-img">
                            <img src="~/Assets/Customer/img/flight/flight-large-02.jpg" class="img-fluid" alt="Slider Img">
                        </div>
                        <div class="service-img">
                            <img src="~/Assets/Customer/img/flight/flight-large-03.jpg" class="img-fluid" alt="Slider Img">
                        </div>
                        <div class="service-img">
                            <img src="~/Assets/Customer/img/flight/flight-large-04.jpg" class="img-fluid" alt="Slider Img">
                        </div>
                        <div class="service-img">
                            <img src="~/Assets/Customer/img/flight/flight-large-05.jpg" class="img-fluid" alt="Slider Img">
                        </div>
                        <div class="service-img">
                            <img src="~/Assets/Customer/img/flight/flight-large-06.jpg" class="img-fluid" alt="Slider Img">
                        </div>
                    </div>
                    <a href="~/Assets/Customer/img/flight/flight-large-04.jpg" data-fancybox="gallery" class="btn btn-white btn-xs view-btn"><i class="isax isax-image me-1"></i>See All</a>
                </div>
                <div class="owl-carousel slider-nav-thumbnails nav-center" id="small-img">
                    <div><img src="~/Assets/Customer/img/flight/flight-thumb-01.jpg" class="img-fluid" alt="Slider Img"></div>
                    <div><img src="~/Assets/Customer/img/flight/flight-thumb-02.jpg" class="img-fluid" alt="Slider Img"></div>
                    <div><img src="~/Assets/Customer/img/flight/flight-thumb-03.jpg" class="img-fluid" alt="Slider Img"></div>
                    <div><img src="~/Assets/Customer/img/flight/flight-thumb-04.jpg" class="img-fluid" alt="Slider Img"></div>
                    <div><img src="~/Assets/Customer/img/flight/flight-thumb-05.jpg" class="img-fluid" alt="Slider Img"></div>
                    <div><img src="~/Assets/Customer/img/flight/flight-thumb-06.jpg" class="img-fluid" alt="Slider Img"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- /Slider -->

    <div class="card shadow-none bg-light-200">
        <div class="card-body pb-1">
            <h5 class="d-flex align-items-center fs-18 mb-3">
                <span class="avatar avatar-md rounded-circle bg-primary me-2"><i class="isax isax-airplane5"></i></span>
                Thông Tin Chuyến Bay
            </h5>
            <div class="row">
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="mb-3">
                        <h6 class="mb-1">Ngày khởi hành</h6>
                        <p>@(lichSomNhat != null ? lichSomNhat.NgayBay.ToString("dd/MM/yyyy") : "")</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="mb-3">
                        <h6 class="mb-1">Thời gian bay</h6>
                        <p>@(lichSomNhat != null ? (lichSomNhat.NgayGioHaCanh - lichSomNhat.NgayGioKhoiHanh).ToString(@"hh\:mm") : "")</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="mb-3">
                        <h6 class="mb-1">Số hiệu</h6>
                        <p>@Model.SoHieuChuyenBay</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="mb-3">
                        <h6 class="mb-1">Số Ghế</h6>
                        <p>160</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-5 col-sm-7">
                    <div class="mb-4">
                        <h6 class="mb-1">Bay từ</h6>
                        <p>@Model.TuyenBay.SanBay.TenSanBay</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-5 col-sm-7">
                    <div class="mb-4">
                        <h6 class="mb-1">Bay đến</h6>
                        <p>@Model.TuyenBay.SanBay1.TenSanBay</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion custom-accordion accordion-shadow-none">
        <div class="accordion-item border-0 mb-4">
            <div class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#accordion_collapse_two" aria-expanded="true">
                    Mô Tả
                </button>
            </div>
            <div id="accordion_collapse_two" class="accordion-collapse collapse show">
                <div class="accordion-body pt-0">
                    <p class="mb-2">
                        Mô tả chuyến bay

                    </p>
                    <div class="read-more">
                        <div class="more-text">
                            <p>
                                Bạn vui lọc đọc nội dung bên dưới hoặc liên hệ với nhân viên cạnh bên
                            </p>
                        </div>
                        <a href="javascript:void(0);" class="fs-14 fw-medium more-link text-decoration-underline mb-2">Show More</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- #region Sơ đồ ghế máy bay -->
        <h5 class="mt-4 mb-3">Sơ đồ ghế máy bay</h5>
        <!-- Seat Status Legend -->
        <style>
            .plane-body {
                width: 340px;
                margin: 0 auto 32px auto;
                position: relative;
                background: #f8f9fa;
                border-radius: 60px 60px 40px 40px/80px 80px 40px 40px;
                box-shadow: 0 2px 16px rgba(0,0,0,0.08);
                padding-bottom: 16px;
            }

            .plane-nose {
                width: 100%;
                height: 60px;
                background: #dde3ea;
                border-radius: 60px 60px 0 0/80px 80px 0 0;
                position: absolute;
                top: -60px;
                left: 0;
                z-index: 2;
            }

            .plane-tail {
                width: 100%;
                height: 40px;
                background: #dde3ea;
                border-radius: 0 0 60px 60px/0 0 40px 40px;
                position: absolute;
                bottom: -40px;
                left: 0;
                z-index: 2;
            }

            .plane-wings {
                position: absolute;
                left: 0;
                right: 0;
                top: 340px; /* khoảng vị trí giữa máy bay, chỉnh lại nếu cần */
                height: 80px;
                pointer-events: none;
                z-index: 1;
            }

            .plane-wing-left, .plane-wing-right {
                position: absolute;
                top: 0;
                width: 90px;
                height: 80px;
                background: #b0c4de;
                opacity: 0.18;
                border-radius: 60% 80% 60% 80%/80% 100% 60% 80%;
            }

            .plane-wing-left {
                left: -90px;
                transform: rotate(-8deg);
            }

            .plane-wing-right {
                right: -90px;
                transform: scaleX(-1) rotate(-8deg);
            }

            .plane-wc {
                width: 100%;
                height: 36px;
                background: #e9ecef;
                border-radius: 0 0 40px 40px/0 0 36px 36px;
                position: relative;
                margin-top: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2;
            }

            .plane-wc-icon {
                width: 24px;
                height: 24px;
                margin: 0 8px;
                background: url('https://cdn-icons-png.flaticon.com/512/61/61088.png') no-repeat center/contain;
                display: inline-block;
                opacity: 0.7;
            }

            .seat-map {
                display: flex;
                flex-direction: column;
                align-items: center;
                position: relative;
                z-index: 2;
            }

            .seat-row {
                display: flex;
                margin-bottom: 2px;
                position: relative;
                z-index: 2;
            }

            .seat {
                width: 32px;
                height: 32px;
                border: 1px solid #ccc;
                margin: 0 2px;
                text-align: center;
                line-height: 32px;
                border-radius: 6px;
                font-size: 14px;
                cursor: pointer;
                background: #fff;
            }

                .seat.booked {
                    background: #bbb;
                    color: #fff;
                    cursor: not-allowed;
                }

                .seat.selected {
                    background: #007bff;
                    color: #fff;
                }

            .seat-row-label {
                width: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
            }

            .seat-class-label {
                font-size: 13px;
                color: #007bff;
                margin-bottom: 4px;
            }

            .wing-left, .wing-right {
                width: 28px;
                height: 32px;
                background: #4bb3fd;
                border-radius: 60% 60% 0 0;
                display: inline-block;
                margin: 0 2px;
                position: relative;
                top: 0;
            }

            .wing-left {
                margin-right: 6px;
            }

            .wing-right {
                margin-left: 6px;
            }

            media (max-width: 600px) {
                .plane-body

            {
                width: 98vw;
                min-width: 0;
            }

            .seat {
                width: 22px;
                height: 22px;
                font-size: 11px;
                line-height: 22px;
            }

            .wing-left, .wing-right {
                width: 18px;
                height: 22px;
            }
            }
        </style>
        <div class="plane-body">
            <div class="plane-nose"></div>
            <div class="plane-wings">
                <div class="plane-wing-left"></div>
                <div class="plane-wing-right"></div>
            </div>
            <form id="seatForm" method="get" action="@Url.Action("DatVe", "ChuyenBay", new { area = "Customer" })">
                <div class="seat-map">
                    @foreach (var hangVe in hangVeList)
                    {
                        var tenHangVe = hangVe.TenHangVe;
                        var soCot = hangVeConfig.ContainsKey(hangVe.MaHangVe) ? hangVeConfig[hangVe.MaHangVe] : 6;

                        // Lấy tất cả vé của hạng vé này
                        var veCuaHangVe = lichSomNhat != null ?
                            lichSomNhat.VeChuyenBay.Where(v => v.HangVe.MaHangVe == hangVe.MaHangVe).ToList() :
                            new List<AirlineWeb.Models.VeChuyenBay>();

                        // Tính số dãy cần thiết (lấy số dãy lớn nhất từ các vé)
                        var soDayGhe = veCuaHangVe.Any() ?
                            veCuaHangVe.Max(v => int.Parse(v.SoGhe.Substring(0, v.SoGhe.Length - 1))) : 1;

                        <div class="seat-class-label">@tenHangVe</div>

                        for (int row = 1; row <= soDayGhe; row++)
                        {
                            <div class="seat-row">
                                <span class="seat-row-label">@row</span>
                                @{
                                    // Tạo danh sách cột theo số cột của hạng vé
                                    var cols = new List<string>();
                                    if (soCot >= 1) { cols.Add("A"); }
                                    if (soCot >= 2) { cols.Add("B"); }
                                    if (soCot >= 3) { cols.Add("C"); }
                                    if (soCot >= 4) { cols.Add("D"); }
                                    if (soCot >= 5) { cols.Add("E"); }
                                    if (soCot >= 6) { cols.Add("F"); }
                                }
                                @foreach (var col in cols)
                                {
                                    var seatCode = $"{row}{col}";
                                    var ve = veCuaHangVe.FirstOrDefault(v => v.SoGhe == seatCode);
                                    var booked = ve != null && ve.TrangThai != 0;
                                    <label class="seat @(booked ? "booked" : "")">
                                        <input type="radio" name="maVe" value="@(ve?.MaVe ?? 0)" style="display:none;" @(booked ? "disabled" : "") />@col
                                    </label>
                                }
                            </div>
                        }
                    }
                </div>
                <button type="submit" class="btn btn-primary mt-3">Đặt Vé</button>
            </form>
            <div class="plane-wc">
                <span class="plane-wc-icon"></span>
                <span style="font-size:13px; color:#555;">WC</span>
                <span class="plane-wc-icon"></span>
            </div>
            <div class="plane-tail"></div>
        </div>
        <script>
            // Highlight ghế đang chọn
            document.querySelectorAll('.seat input[type=radio]').forEach(function (radio) {
                radio.addEventListener('change', function () {
                    document.querySelectorAll('.seat').forEach(function (seat) {
                        seat.classList.remove('selected');
                    });
                    if (this.checked) {
                        this.parentElement.classList.add('selected');
                    }
                });
            });
        </script>
        <!-- #endregion Sơ đồ ghế máy bay -->
        <!-- #region Câu hỏi thường gặp -->
        <div class="accordion-item mb-4 border-0">
            <div class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#accordion_collapse_eight" aria-expanded="true">
                    Câu hỏi thường gặp
                </button>
            </div>
            <div id="accordion_collapse_eight" class="accordion-collapse collapse show">
                <div class="accordion faq-accordion" id="accordionFaq">
                    <div class="accordion-item show mb-2">
                        <div class="accordion-header">
                            <button class="accordion-button fw-medium" type="button" data-bs-toggle="collapse" data-bs-target="#faq-collapseOne" aria-expanded="false" aria-controls="faq-collapseOne">
                                Làm thế nào để đặt vé máy bay trực tuyến?
                            </button>
                        </div>
                        <div id="faq-collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionFaq">
                            <div class="accordion-body">
                                <p class="mb-0">
                                    Bạn có thể đặt vé máy bay trực tuyến qua website của chúng tôi hoặc ứng dụng di động. Chọn điểm đi, điểm đến, ngày bay, hạng vé (Phổ Thông, Thương Gia, Hạng Nhất), sau đó nhập thông tin hành khách và thanh toán. Vé sẽ được gửi qua email hoặc lưu trong tài khoản của bạn.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item mb-2">
                        <div class="accordion-header">
                            <button class="accordion-button fw-medium collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq-two" aria-expanded="false" aria-controls="faq-two">
                                Hành lý ký gửi và hành lý xách tay được quy định như thế nào?
                            </button>
                        </div>
                        <div id="faq-two" class="accordion-collapse collapse" data-bs-parent="#accordionFaq">
                            <div class="accordion-body">
                                <p class="mb-0">
                                    Hành lý xách tay tối đa 7kg (kích thước không quá 56x36x23cm). Hành lý ký gửi phụ thuộc vào hạng vé: Phổ Thông (20-23kg), Phổ Thông Cao Cấp (30kg), Thương Gia/Hạng Nhất (40kg). Vui lòng kiểm tra quy định cụ thể của hãng hàng không (Vietnam Airlines, Vietjet Air, Bamboo Airways, v.v.) khi đặt vé.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item mb-2">
                        <div class="accordion-header">
                            <button class="accordion-button fw-medium collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq-three" aria-expanded="false" aria-controls="faq-three">
                                Tôi cần làm gì để làm thủ tục check-in?
                            </button>
                        </div>
                        <div id="faq-three" class="accordion-collapse collapse" data-bs-parent="#accordionFaq">
                            <div class="accordion-body">
                                <p class="mb-0">
                                    Bạn có thể check-in trực tuyến qua website hoặc ứng dụng từ 24-48 giờ trước giờ bay, hoặc tại quầy check-in ở sân bay (HAN, SGN, DAD, v.v.) ít nhất 45 phút trước chuyến bay nội địa và 60 phút trước chuyến bay quốc tế. Mang theo giấy tờ tùy thân (CCCD hoặc hộ chiếu).
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <div class="accordion-header">
                            <button class="accordion-button fw-medium collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq-four" aria-expanded="false" aria-controls="faq-four">
                                Nếu chuyến bay bị hủy, tôi sẽ được xử lý như thế nào?
                            </button>
                        </div>
                        <div id="faq-four" class="accordion-collapse collapse" data-bs-parent="#accordionFaq">
                            <div class="accordion-body">
                                <p class="mb-0">
                                    Nếu chuyến bay bị hủy, bạn sẽ được hãng hàng không (Vietnam Airlines, Vietjet Air, Bamboo Airways, v.v.) sắp xếp chuyến bay thay thế hoặc hoàn tiền theo chính sách. Liên hệ qua email hoặc số điện thoại hỗ trợ của chúng tôi để được hỗ trợ nhanh chóng.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- #endregion Câu hỏi thường gặp -->

</div>
<!-- #endregion Nội dung chính -->
<!-- #region Nội dung menu phải -->
<div class="col-xl-4 theiaStickySidebar">
    <div class="card shadow-none">
        <div class="card-body">
            <h5 class="fs-18 mb-3">Tại sao lại là chúng tôi!?</h5>
            <div>
                <p class="d-flex align-items-center mb-3">
                    <span class="avatar avatar-md bg-light rounded-circle text-dark me-2">
                        <i class="isax isax-medal-star"></i>
                    </span>Đội ngũ kinh nghiệp
                </p>
                <p class="d-flex align-items-center mb-3">
                    <span class="avatar avatar-md bg-light rounded-circle text-dark me-2">
                        <i class="isax isax-menu"></i>
                    </span>Quản lý tìm kiếm vé hiệu quả
                </p>
                <p class="d-flex align-items-center mb-3">
                    <span class="avatar avatar-md bg-light rounded-circle text-dark me-2">
                        <i class="isax isax-message-minus"></i>
                    </span>Dễ sử dụng
                </p>
                <p class="d-flex align-items-center mb-3">
                    <span class="avatar avatar-md bg-light rounded-circle text-dark me-2">
                        <i class="isax isax-user-add"></i>
                    </span>Đội ngũ nhân viên giàu kinh nghiệp
                </p>
                <p class="d-flex align-items-center">
                    <span class="avatar avatar-md bg-light rounded-circle text-dark me-2">
                        <i class="isax isax-grammerly"></i>
                    </span>Hỗ trợ 24/7
                </p>
            </div>
        </div>
    </div>
    <div class="card shadow-none mb-0">
        <div class="card-body">
            <h5 class="fs-18 mb-3">Về Chúng Tôi</h5>
            <div class="py-1">
                <div class="bg-light-500 br-10 mb-3 d-flex align-items-center p-3">
                    <a href="javascript:void(0);" class="avatar avatar-lg flex-shrink-0">
                        <img src="~/Assets/Customer/img/users/user-05.jpg" alt="img" class="rounded-circle">
                    </a>
                    <div class="ms-2 overflow-hidden">
                        <h6 class="fw-medium text-truncate"><a href="javascript:void(0);">User</a></h6>
                        <p class="fs-14">Thành viên : 14/05/2024</p>
                    </div>
                </div>
                <div class="border br-10 mb-3 p-3">
                    <div class="d-flex align-items-center border-bottom pb-3 mb-3">
                        <span class="avatar avatar-sm me-2 rounded-circle flex-shrink-0 bg-primary">
                            <i class="isax isax-call-outgoing5"></i>
                        </span>
                        <p>097 1234 567</p>
                    </div>
                    <div class="d-flex align-items-center border-bottom pb-3 mb-3">
                        <span class="avatar avatar-sm me-2 rounded-circle flex-shrink-0 bg-primary">
                            <i class="isax isax-message-search5"></i>
                        </span>
                        <p>
                            <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="c0a9aea6af80a5b8a1adb0aca5eea3afad">
                                User@gmail.com
                            </a>
                        </p>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="avatar avatar-sm me-2 rounded-circle flex-shrink-0 bg-primary"><i class="isax isax-location-tick5"></i></span>
                        <p>123 Phan Đăng lưu</p>
                    </div>
                </div>
            </div>
            <div class="row g-2">
                <div class="col-sm-6">
                    <a href="javascript:void(0);" class="btn btn-light d-flex align-items-center justify-content-center">
                        <i class="isax isax-messages5 me-2"></i>Chat bot
                    </a>
                </div>
                <div class="col-sm-6">
                    <a href="chat.html.htm" class="btn btn-primary d-flex align-items-center justify-content-center">
                        <i class="isax isax-message-notif5 me-2"></i>Tư vấn tt
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- #endregion Nội dung menu phải -->